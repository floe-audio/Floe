# Copyright 2024 Sam Windell
# SPDX-License-Identifier: GPL-3.0-or-later

name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

env:
  SENTRY_DSN: ${{ secrets.SENTRY_DSN_PRODUCTION }}
  # Specify a relative path for reproducible builds (no absolute paths in binaries).
  ZIG_GLOBAL_CACHE_DIR: .zig-cache-global 

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04 
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/flakehub-cache-action@main
      - uses: nicknovitski/nix-develop@v1.1.0

      - run: |
          zig build release:github -Dbuild-mode=production -Dtargets=linux,windows,mac_arm,mac_x86 -Dfetch-floe-logos=true -Dgithub-publish-release=true
        env:
          WINDOWS_CODESIGN_CERT_PFX: ${{ secrets.WINDOWS_CODESIGN_CERT_PFX }}
          WINDOWS_CODESIGN_CERT_PFX_PASSWORD: ${{ secrets.WINDOWS_CODESIGN_CERT_PFX_PASSWORD }}
          MACOS_APP_STORE_CONNECT_API_KEY_JSON: ${{ secrets.MACOS_APP_STORE_CONNECT_API_KEY_JSON }}
          MACOS_DEV_INSTALLER_CERT_P12_PASSWORD: ${{ secrets.MACOS_DEV_INSTALLER_CERT_P12_PASSWORD }}
          MACOS_DEV_INSTALLER_CERT_P12: ${{ secrets.MACOS_DEV_INSTALLER_CERT_P12 }}
          MACOS_DEV_APP_CERT_P12_PASSWORD: ${{ secrets.MACOS_DEV_APP_CERT_P12_PASSWORD }}
          MACOS_DEV_APP_CERT_P12: ${{ secrets.MACOS_DEV_APP_CERT_P12 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Get version'
        run: |
          export VERSION=$(cat version.txt)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create Sentry release
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          release: floe@${{ env.VERSION }}

      - name: Clean up awaiting-release labels
        run: just close-released-issues ${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger website deployment
        if: success()
        run: |
          gh workflow run deploy-website.yml --ref main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - if: '!cancelled()'
        run: |
          icon=""
          if [ "${{ job.status }}" == "success" ]; then
            icon="✅"
          else
            icon="❌"
          fi
          status="$icon Floe release v${{ env.VERSION }}: ${{ job.status }}"
          curl -d "$status" "ntfy.sh/${{ secrets.NTFY_RELEASE_URL }}"

